# 股票API動態查詢功能使用指南

## 🚀 功能概述

這個混合式股票名稱查詢系統整合了多種方式來獲取股票公司名稱：

1. **Yahoo Finance API** - 主要查詢來源，支援全球市場
2. **本地靜態清單** - 備援機制，包含熱門股票
3. **智能快取系統** - 24小時快取，減少API調用
4. **自動重試機制** - 確保查詢穩定性

## 📈 支援市場

- **台股 (TWD)** - 支援所有上市櫃股票和ETF
- **美股 (USD)** - 支援NYSE、NASDAQ等主要交易所

## 🔧 功能特色

### 1. 智能查詢順序
```
用戶輸入股票代號 → 檢查本地快取 → 查詢Yahoo Finance API → 回退到靜態清單 → 顯示結果
```

### 2. 自動格式轉換
- **台股**: `2330` → `2330.TW` (API查詢格式)
- **美股**: `aapl` → `AAPL` (自動轉大寫)

### 3. 快取機制
- **快取時間**: 24小時自動過期
- **快取範圍**: 按市場分類存儲
- **快取管理**: 支援手動清除和統計查看

### 4. 錯誤處理
- **重試機制**: 最多3次重試，指數退避延遲
- **降級處理**: API失敗時自動使用靜態清單
- **用戶體驗**: 載入狀態提示，不阻塞操作

## 💡 使用方式

### 基本使用
1. 選擇市場類型（台股/美股）
2. 輸入股票代號
3. 點擊其他欄位（觸發blur事件）
4. 系統自動查詢並顯示完整名稱

### 查詢狀態提示
- `查詢中...` - 正在API查詢
- `AAPL Apple Inc.` - 查詢成功
- `UNKN` - 查詢失敗，只顯示代號

## 🎛️ API控制面板

在「投資總覽」頁籤底部有API狀態監控區塊：

### 狀態顯示
- **快取狀態**: 顯示有效快取項目數量
- **API服務**: 顯示Yahoo Finance API連接狀態

### 控制按鈕
- **清除快取**: 手動清除所有股票名稱快取
- **測試API**: 測試Yahoo Finance API連接狀態  
- **重新整理**: 更新快取統計和API狀態

### 詳細統計
- **快取項目**: 總快取項目數
- **有效項目**: 未過期的快取項目
- **過期項目**: 已過期但未清除的項目

## 🔄 預載功能

系統會在啟動後2秒自動預載熱門股票名稱：

### 台股熱門股票
- 2330 (台積電)
- 2317 (鴻海) 
- 2454 (聯發科)
- 0050 (台灣50)
- 0056 (高股息)

### 美股熱門股票  
- AAPL (Apple)
- MSFT (Microsoft)
- GOOGL (Google)
- TSLA (Tesla)
- SPY (S&P 500 ETF)

## ⚡ 性能與限制

### API限制
- **Yahoo Finance**: 每小時2000次請求，每天48000次
- **請求間隔**: 200毫秒最小間隔
- **並發限制**: 最多5個同時請求

### 快取優化
- **命中率**: 熱門股票接近100%命中
- **存儲大小**: 每項約100-200字節
- **過期策略**: 24小時自動過期

### 網路需求
- **在線查詢**: 需要網路連接
- **離線降級**: 使用本地靜態清單（39台股+42美股）

## 🛠️ 技術細節

### 查詢格式
```javascript
// 台股查詢URL
https://query1.finance.yahoo.com/v1/finance/search?q=2330.TW&quotesCount=1&newsCount=0

// 美股查詢URL  
https://query1.finance.yahoo.com/v1/finance/search?q=AAPL&quotesCount=1&newsCount=0
```

### 快取結構
```javascript
{
  "台股:2330": {
    "name": "台灣積體電路製造股份有限公司",
    "timestamp": 1672531200000,
    "isValid": true
  }
}
```

### 重試策略
```javascript
// 重試延遲: 1秒, 2秒, 4秒  
Math.pow(2, attempt) * 1000
```

## 🐛 常見問題

### Q: 為什麼某些股票查不到名稱？
A: 可能的原因：
1. 股票已下市或暫停交易
2. API暫時不可用（會顯示代號）
3. 網路連接問題

### Q: 快取什麼時候會清除？
A: 
1. 自動過期（24小時後）
2. 手動點擊「清除快取」
3. 瀏覽器清除本地數據

### Q: 可以新增更多靜態股票清單嗎？
A: 可以在 `js/features/stocks.js` 中的 `taiwanStocks` 和 `usStocks` 物件添加更多股票。

### Q: API查詢失敗會怎麼樣？
A: 系統會自動：
1. 重試3次（指數退避延遲）
2. 回退到靜態清單查詢
3. 最終只顯示股票代號

## 🔐 隱私與安全

- **無個人數據**: 只查詢公開股票資訊
- **本地快取**: 快取存儲在瀏覽器本地
- **HTTPS查詢**: 所有API請求使用加密連接
- **無追蹤**: 不發送個人識別資訊

## 🆕 版本更新

### v1.0.0
- ✅ Yahoo Finance API整合
- ✅ 24小時智能快取
- ✅ 自動重試機制  
- ✅ API狀態監控
- ✅ 台股美股支援
- ✅ 預載熱門股票

---

如有問題或建議，請參考項目文檔或聯繫開發團隊。 